<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - LendScape</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
</head>
<body>
<script src="{{ url_for('static', filename='js/utils.js')}}"></script>
<script src="{{ url_for('static', filename='js/users.js')}}"></script>
<script src="{{ url_for('static', filename='js/profile.js')}}"></script>

<!-- Hidden input for user ID -->
<input type="hidden" id="user-id" value="">

<!-- Navigation -->
<nav class="navbar">
    <div class="nav-container">
        <div class="logo">üì¶ LendScape</div>
        <div class="nav-menu">
            <a href="{{ url_for('main.index') }}">Home</a>
            <a href="{{ url_for('items.search_page') }}">Browse</a>
            <a href="{{ url_for('items.map_page') }}"> Items Map</a>
            {% if current_user %}
            <a href="{{ url_for('items.create_item_page') }}">Create Item</a>
            <a href="{{ url_for('stats.top_users_page')}}">Active Users</a>
            {% endif %}
        </div>
        <div class="user-menu">
            <div class="notification-icon">
                üîî
                <span class="notification-badge"></span>
            </div>
            <!-- Áî®Êà∑Â§¥ÂÉèÂíå‰∏ãÊãâËèúÂçï -->
            <div class="user-avatar" id="nav-avatar" onclick="toggleDropdown(event)">
                {% if logged_in_user %}
                {{ (logged_in_user.firstName[0] if logged_in_user.firstName else logged_in_user.email[0] if logged_in_user.email else 'U') | upper }}
                {% else %}
                -
                {% endif %}
                <!-- ‰∏ãÊãâËèúÂçï -->
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="{{ url_for('users.user_detail_page', userid=logged_in_id) }}">My Profile</a>
                    <a href="{{ url_for('items.create_item_page') }}">Create Item</a>
                    <div class="divider"></div>
                    <a onclick="logout()" class="logout">Logout</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="profile-card">
            <div class="profile-header" id="profile-card">
                <div class="profile-avatar" id="profile-avatar">-</div>
                <div class="profile-name" id="profile-name">Loading...</div>
                <div class="profile-username" id="profile-email">-</div>
            </div>
            <div class="profile-stats" id="profile-stats">
                <div class="stat">
                    <div class="stat-value" id="items-count">0</div>
                    <div class="stat-label">Lending</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-orders">0</div>
                    <div class="stat-label">Borrowing</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="user-rating" data-rating-loaded="false">Loading...</div>
                    <div class="stat-label">Rating</div>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="nav-link" data-section="items">
                <span class="nav-icon">üì¶</span>
                {% if logged_in_id == user_id %}
                My Items
                {% else %}
                Items
                {% endif %}
            </a>
            <a href="#" class="nav-link active" data-section="borrowing">
                <span class="nav-icon">üì•</span>
                Borrowing (<span id="borrower-count">0</span>)
            </a>

            <a href="#" class="nav-link" data-section="lending">
                <span class="nav-icon">üì§</span>
                Lending (<span id="lender-count">0</span>)
            </a>
            {%if logged_in_id == user_id%}
            <a href="#" class="nav-link" data-section="requests">
                <span class="nav-icon">üìã</span>
                Requests (<span id="requests-count">0</span>)
            </a>
            <a href="#" class="nav-link" data-section="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                Settings
            </a>
            {%endif%}
            <a href="#" class="nav-link" data-section="stats">
                <span class="nav-icon">üìä</span>
                Stats
            </a>
        </nav>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Loading State -->
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Loading user data...</p>
        </div>

        <div id="error-message" class="error-message"></div>

        <!-- My Items Section -->
        <div id="items-section" class="orders-section">
            <div class="content-header">
                <h1 class="content-title">My Items</h1>
                {% if logged_in_user == user_id %}
                <button class="btn btn-primary" onclick="window.location.href='/items/create'">
                    <span>+</span> Add New Item
                </button>
                {% endif %}
            </div>

            <div class="items-grid">
                <!-- Add Item Card - Always visible -->
                {% if logged_in_user == user_id %}
                <div class="add-item-card" onclick="window.location.href='{{ url_for('items.create_item_page') }}'">
                    <div class="add-item-content">
                        <div class="add-item-icon">+</div>
                        <div class="add-item-text">List an Item</div>
                    </div>
                </div>
                {% endif %}
                <!-- User items will be dynamically loaded here -->
                <div id="ownership-results"></div>
            </div>
        </div>

        <div id="borrowing-section" class="orders-section active">
            <div class="content-header">
                <h1 class="content-title">My Borrowing Orders</h1>
                <button class="btn btn-primary" onclick="refreshUserDetail()">
                    üîÑ Refresh
                </button>
            </div>
            <div id="borrower-orders-results"></div>
        </div>

        <!-- Lending Orders Section -->
        <div id="lending-section" class="orders-section">
            <div class="content-header">
                <h1 class="content-title">My Lending Orders</h1>
                <button class="btn btn-primary" onclick="refreshUserDetail()">
                    üîÑ Refresh
                </button>
            </div>
            <div id="lender-orders-results"></div>
        </div>

        <div id="requests-section" class="orders-section">
            <div class="content-header">
                <h1 class="content-title">My Requests</h1>
                <div class="request-tabs">
                    <button class="tab-btn active" data-tab="received">
                        Received (<span id="received-count">0</span>)
                    </button>
                    <button class="tab-btn" data-tab="sent">
                        Sent (<span id="sent-count">0</span>)
                    </button>
                </div>
                <button class="btn btn-primary" onclick="refreshRequests()">
                    üîÑ Refresh
                </button>
            </div>

            <div id="received-requests" class="requests-container active">
                <div class="requests-list" id="received-requests-list">
                </div>
            </div>

            <div id="sent-requests" class="requests-container">
                <div class="requests-list" id="sent-requests-list">
                </div>
            </div>
        </div>

        <div id="settings-section" class="orders-section">
            <div class="content-header">
                <h1 class="content-title">Settings</h1>
            </div>

            <div class="settings-container">
                <!-- Profile Settings -->
                <div class="settings-group">
                    <h3 class="settings-group-title">Profile Settings</h3>

                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-label">Change Address</div>
                            <div class="settings-description">Update your default address</div>
                        </div>
                        <div class="settings-action">
                            <button class="settings-btn primary" onclick="toggleAddressForm()">Change Address</button>
                        </div>
                    </div>

                    <div id="address-form" class="address-form">
                        <div class="form-group">
                            <label for="street">Street Address</label>
                            <input type="text" id="street" placeholder="123 Main St">
                        </div>
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" placeholder="Boston">
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" placeholder="MA">
                        </div>
                        <div class="form-group">
                            <label for="zip">ZIP Code</label>
                            <input type="text" id="zip" placeholder="02134">
                        </div>
                        <div class="form-actions">
                            <button class="settings-btn primary" onclick="saveAddress()">Save Address</button>
                            <button class="settings-btn secondary" onclick="toggleAddressForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="settings-group">
                    <h3 class="settings-group-title">Account Settings</h3>

                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-label">Sign Out</div>
                            <div class="settings-description">Sign out from your LendScape account</div>
                        </div>
                        <div class="settings-action">
                            <button class="settings-btn secondary" onclick="logout()">Sign Out</button>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="settings-group danger-zone">
                    <h3 class="settings-group-title">Danger Zone</h3>

                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-label">Delete Account</div>
                            <div class="settings-description">Permanently delete your account and all associated data. This action cannot be undone.</div>
                        </div>
                        <div class="settings-action">
                            <button class="settings-btn danger" onclick="confirmDeleteAccount()">Delete Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div id="stats-section" class="orders-section">
            <div class="content-header">
                <h1 class="content-title">Statistics</h1>
                <button class="btn btn-primary" onclick="refreshStats()">
                    üîÑ Refresh
                </button>
            </div>

            <div class="stats-container">
                <!-- Âπ≥ÂùáÁßüËµÅÊó∂Èïø -->
                <div class="stats-card">
                    <div class="stats-card-header">
                        <span class="stats-icon">‚è±Ô∏è</span>
                        <h3>Average Rental Duration</h3>
                    </div>
                    <div class="stats-card-body">
                        <div class="stats-row">
                            <div class="stats-item">
                                <div class="stats-label">Average Borrow Time</div>
                                <div class="stats-value" id="avg-borrow-days">--</div>
                                <div class="stats-unit">days</div>
                            </div>
                            <div class="stats-item">
                                <div class="stats-label">Average Lend Time</div>
                                <div class="stats-value" id="avg-lend-days">--</div>
                                <div class="stats-unit">days</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Áî®Êà∑Ê¥ªË∑ÉÂ∫¶ -->
                <div class="stats-card">
                    <div class="stats-card-header">
                        <span class="stats-icon">üìä</span>
                        <h3>Activity</h3>
                    </div>
                    <div class="stats-card-body">
                        <div class="stats-row">
                            <div class="stats-item">
                                <div class="stats-label">Borrow Requests</div>
                                <div class="stats-value" id="borrow-requests">--</div>
                            </div>
                            <div class="stats-item">
                                <div class="stats-label">Lend Requests</div>
                                <div class="stats-value" id="lend-requests">--</div>
                            </div>
                            <div class="stats-item highlight">
                                <div class="stats-label">Total Activity</div>
                                <div class="stats-value" id="total-activity">--</div>
                            </div>
                        </div>
                        <div class="stats-period">
                            Period: <span id="activity-period-start">--</span> to now
                        </div>
                    </div>
                </div>

                <!-- ÂÄüÂá∫ÊàêÂäüÁéá -->
                <div class="stats-card">
                    <div class="stats-card-header">
                        <span class="stats-icon">‚úÖ</span>
                        <h3>Lending Success Rate</h3>
                    </div>
                    <div class="stats-card-body">
                        <div class="success-rate-display">
                            <div class="success-rate-circle">
                                <svg class="progress-ring" width="120" height="120">
                                    <circle class="progress-ring-circle-bg"
                                            stroke="#e0e0e0"
                                            stroke-width="8"
                                            fill="transparent"
                                            r="52"
                                            cx="60"
                                            cy="60"/>
                                    <circle id="success-rate-circle"
                                            class="progress-ring-circle"
                                            stroke="#4CAF50"
                                            stroke-width="8"
                                            fill="transparent"
                                            r="52"
                                            cx="60"
                                            cy="60"
                                            stroke-dasharray="326.73"
                                            stroke-dashoffset="326.73"/>
                                </svg>
                                <div class="success-rate-text">
                                    <span id="success-rate-value">--</span>%
                                </div>
                            </div>
                            <div class="success-rate-details">
                                <div class="stats-detail-row">
                                    <span class="detail-label">Accepted:</span>
                                    <span class="detail-value" id="accepted-count">--</span>
                                </div>
                                <div class="stats-detail-row">
                                    <span class="detail-label">Rejected:</span>
                                    <span class="detail-value" id="rejected-count">--</span>
                                </div>
                                <div class="stats-detail-row">
                                    <span class="detail-label">Total Processed:</span>
                                    <span class="detail-value" id="total-processed">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ÂàáÊç¢‰∏ãÊãâËèúÂçï
    function toggleDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('dropdownMenu');
        if (dropdown) {
            dropdown.classList.toggle('show');
        }
    }

    // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
    document.addEventListener('click', function() {
        const dropdown = document.getElementById('dropdownMenu');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    });

    // ÁôªÂá∫ÂäüËÉΩ
    async function logout() {
        if (!confirm('Are you sure you want to logout?')) {
            return;
        }

        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Logout failed. Please try again.');
            }
        } catch (error) {
            alert('An error occurred: ' + error.message);
        }
    }
</script>

</body>
</html>