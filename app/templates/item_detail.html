<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Details - LendScape</title>
    <style>
        .reviews-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .reviews-stats {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .average-rating {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .average-rating-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .rating-selector {
            display: flex;
            gap: 5px;
            font-size: 30px;
        }

        .rating-selector .star {
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }

        .rating-selector .star:hover {
            color: #ffc107;
        }

        .rating-selector .star.filled {
            color: #ffc107;
        }

        .total-reviews {
            color: #666;
            font-size: 14px;
        }

        .rating-distribution {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rating-bar-label {
            width: 60px;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .rating-bar-track {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .rating-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .rating-bar-count {
            width: 30px;
            text-align: right;
            font-size: 14px;
            color: #999;
        }

        .reviews-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .review-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .review-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .review-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .review-author-info {
            display: flex;
            flex-direction: column;
        }

        .review-author-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        .review-date {
            font-size: 12px;
            color: #999;
        }

        .review-rating {
            display: flex;
            gap: 2px;
        }

        .review-content {
            color: #666;
            line-height: 1.6;
            font-size: 14px;
        }

        .no-reviews {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-reviews-icon {
            font-size: 64px;
            opacity: 0.3;
            margin-bottom: 15px;
        }

        .write-review-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .write-review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .write-review-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .load-more-btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .load-more-btn:hover {
            background: #667eea;
            color: white;
        }

        .review-loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .review-loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .back-button:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .detail-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .detail-container {
                grid-template-columns: 1fr;
            }
        }

        /* å·¦ä¾§ï¼šå›¾ç‰‡å’ŒåŸºæœ¬ä¿¡æ¯ */
        .item-main-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .item-image-container {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 120px;
            position: relative;
            overflow: hidden;
        }

        .item-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            backdrop-filter: blur(10px);
        }

        .item-status-badge.available {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }

        .item-status-badge.rented {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
        }

        .item-info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }

        .item-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .meta-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            font-weight: 600;
        }

        .meta-value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .item-price-display {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .item-price-display span {
            font-size: 18px;
            color: #999;
            font-weight: normal;
        }

        .item-description-section {
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .item-description-text {
            color: #666;
            line-height: 1.6;
            font-size: 15px;
        }

        /* å³ä¾§ï¼šè®¢å•ä¿¡æ¯å’Œæ“ä½œ */
        .item-side-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .action-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e8f4f8;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: white;
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        .btn-danger:hover {
            background: #dc3545;
            color: white;
        }

        .btn-pending {
            background: #ffc107;
            color: #333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .owner-info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }

        .owner-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .owner-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .owner-details {
            flex: 1;
        }

        .owner-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .owner-email {
            font-size: 14px;
            color: #666;
        }

        .order-status-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #dee2e6;
        }

        .order-status-empty {
            text-align: center;
            padding: 30px 20px;
            color: #999;
        }

        .order-status-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .order-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .order-detail {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }

        .order-label {
            color: #666;
            font-weight: 500;
        }

        .order-value {
            color: #333;
            font-weight: 600;
        }

        .order-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-status.active {
            background: #d4edda;
            color: #155724;
        }

        .order-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .order-status.completed {
            background: #cce5ff;
            color: #004085;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
<div class="container">
    <a href="/items/search" class="back-button">
        <span>â†</span> Back to Items
    </a>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading item details...</p>
    </div>

    <!-- é”™è¯¯ä¿¡æ¯ -->
    <div id="error-message" class="error-message" style="display: none;"></div>

    <!-- è¯¦æƒ…å®¹å™¨ -->
    <div class="detail-container" id="item-detail" style="display: none;">
        <!-- å·¦ä¾§ï¼šä¸»è¦ä¿¡æ¯ -->
        <div class="item-main-section">
            <!-- å›¾ç‰‡ -->
            <div class="item-image-container" id="item-image">
                <span id="item-emoji">ğŸ“¦</span>
                <img id="item-img" src="" alt="" style="display: none;">
                <span class="item-status-badge available" id="status-badge">Available</span>
            </div>

            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="item-info-card">
                <h1 class="item-title" id="item-name">Loading...</h1>

                <div class="item-meta">
                    <div class="meta-item">
                        <span class="meta-label">Item ID</span>
                        <span class="meta-value" id="item-id">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Category</span>
                        <span class="meta-value" id="item-category">General</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Added Date</span>
                        <span class="meta-value" id="item-date">-</span>
                    </div>
                    <div class="meta-item" id="location-meta" style="display: none;">
                        <span class="meta-label">Location</span>
                        <span class="meta-value" id="item-location">-</span>
                    </div>
                </div>

                <div class="item-price-display" id="item-price">
                    $0 <span>/day</span>
                </div>
            </div>

            <!-- æè¿° -->
            <div class="item-description-section">
                <h3 class="section-title">Description</h3>
                <p class="item-description-text" id="item-description">
                    No description available.
                </p>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè®¢å•ä¿¡æ¯å’Œæ“ä½œ -->
        <div class="item-side-section">
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-card">
                <h3 class="section-title">Actions</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="rent-btn" onclick="rentItem()">
                        Request to Rent
                    </button>
                    <button class="btn btn-secondary" id="edit-btn" onclick="editItem()" style="display: none;">
                        Edit Item
                    </button>
                    <button class="btn btn-danger" id="delete-btn" onclick="deleteItem()" style="display: none;">
                        Delete Item
                    </button>
                </div>
            </div>

            <div class="owner-info-card" data-owner-id="">
                <h3 class="section-title">Owner Information</h3>
                <div class="owner-info">
                    <div class="owner-avatar" id="owner-avatar">-</div>
                    <div class="owner-details">
                        <div class="owner-name" id="owner-name">Loading...</div>
                        <div class="owner-email" id="owner-email">-</div>
                    </div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 15px;" onclick="contactOwner()">
                    View Profile
                </button>
            </div>

            <!-- è®¢å•çŠ¶æ€ -->
            <div class="order-status-card">
                <h3 class="section-title">Order Status</h3>

                <!-- æ— è®¢å•çŠ¶æ€ -->
                <div class="order-status-empty" id="no-order" style="display: block;">
                    <div class="order-status-icon">ğŸ“‹</div>
                    <p>No active orders for this item</p>
                    <p style="font-size: 14px; color: #999;">This item is available for rent</p>
                </div>

                <!-- æœ‰è®¢å•çŠ¶æ€ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div class="order-info" id="order-info" style="display: none;">
                    <div class="order-detail">
                        <span class="order-label">Order ID:</span>
                        <span class="order-value" id="order-id">#-</span>
                    </div>
                    <div class="order-detail">
                        <span class="order-label">Borrower:</span>
                        <span class="order-value" id="renter-name">-</span>
                    </div>
                    <div class="order-detail">
                        <span class="order-label">Status:</span>
                        <span class="order-status active" id="order-status">Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ä»Flaskæ¨¡æ¿è·å–ç”¨æˆ·ä¿¡æ¯
    const currentUserId = {{ user_id | tojson if user_id else 'null' }};
    const currentUser = {{ current_user.to_dict() | tojson if current_user else 'null' }};

    // å¦‚æœæœ‰ç”¨æˆ·IDï¼Œå­˜å‚¨åˆ°sessionStorageä¾›å…¶ä»–æ“ä½œä½¿ç”¨
    if (currentUserId) {
        sessionStorage.setItem('user_id', currentUserId);
        sessionStorage.setItem('userId', currentUserId);  // å…¼å®¹ä¸¤ç§å‘½å
    }

    // è·å–ç‰©å“IDï¼ˆä»URLä¸­ï¼‰
    const itemId = window.location.pathname.split('/').pop();
    let currentItem = null; // å­˜å‚¨å½“å‰ç‰©å“ä¿¡æ¯

    // é¡µé¢åŠ è½½æ—¶è·å–ç‰©å“è¯¦æƒ…
    document.addEventListener('DOMContentLoaded', function() {
        loadItemDetails();
    });

    // åŠ è½½ç‰©å“è¯¦æƒ…
    async function loadItemDetails() {
        console.log("Load item details triggered")
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        const detailDiv = document.getElementById('item-detail');

        loading.style.display = 'block';
        errorDiv.style.display = 'none';
        detailDiv.style.display = 'none';

        try {
            // è·å–ç‰©å“è¯¦æƒ…
            const response = await fetch(`/api/items/${itemId}`);
            console.log(`/api/items/${itemId}`)
            console.log(response)
            if (!response.ok) {
                throw new Error('Item not found');
            }

            const item = await response.json();
            currentItem = item; // ä¿å­˜ç‰©å“ä¿¡æ¯

            // å¡«å……æ•°æ®ï¼ˆæ ¹æ®ORMæ¨¡å‹ï¼‰
            document.getElementById('item-name').textContent = item.itemName || 'Unnamed Item';
            document.getElementById('item-id').textContent = `#${item.itemId || itemId}`;
            document.getElementById('item-description').textContent = item.description || 'No description available.';
            document.getElementById('item-price').innerHTML = `$${item.price || 0} <span>/day</span>`;

            // å¤„ç†å›¾ç‰‡
            if (item.image_url) {
                const img = document.getElementById('item-img');
                img.src = item.image_url;
                img.style.display = 'block';
                document.getElementById('item-emoji').style.display = 'none';
            }

            // å¤„ç†çŠ¶æ€
            const statusBadge = document.getElementById('status-badge');
            if (item.is_available) {
                statusBadge.textContent = 'Available';
                statusBadge.className = 'item-status-badge available';
                document.getElementById('rent-btn').disabled = false;
            } else {
                statusBadge.textContent = 'Rented';
                statusBadge.className = 'item-status-badge rented';
                document.getElementById('rent-btn').disabled = true;
                document.getElementById('rent-btn').textContent = 'Currently Unavailable';
            }

            // è®¾ç½®æ—¥æœŸ
            if (item.createdAt) {
                const date = new Date(item.createdAt);
                document.getElementById('item-date').textContent = date.toLocaleDateString();
            }

            // åŠ è½½æ‰€æœ‰è€…ä¿¡æ¯
            await loadOwnerInfo(item.userId);

            // åŠ è½½è®¢å•ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            await loadOrderInfo(item.itemId || itemId);

            // æ£€æŸ¥æ˜¯å¦ä¸ºç‰©å“æ‰€æœ‰è€…
            checkOwnership(item.userId);

            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„è¯·æ±‚
            await checkPendingRequests(item.itemId);

            loading.style.display = 'none';
            detailDiv.style.display = 'grid';

        } catch (error) {
            console.error('Error loading item details:', error);
            loading.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'Error loading item details. ' + error.message;
        }
    }

    // åŠ è½½æ‰€æœ‰è€…ä¿¡æ¯ï¼ˆåŸºäºUseræ¨¡å‹ï¼‰
    async function loadOwnerInfo(userId) {
        try {
            const response = await fetch(`/api/users/${userId}`);
            if (response.ok) {
                const data = await response.json();
                // å¤„ç†æ–°APIè¿”å›çš„æ•°æ®ç»“æ„
                const user = data.user_info || data;

                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() ||
                    user.username || 'Unknown User';

                document.getElementById('owner-name').textContent = fullName;
                document.getElementById('owner-email').textContent = user.email || '-';
                document.getElementById('owner-avatar').textContent =
                    (fullName ? fullName[0] : 'U').toUpperCase();

                // ä¿å­˜owner IDåˆ°dataå±æ€§
                document.querySelector('.owner-info-card').dataset.ownerId = userId;

                // å¦‚æœæœ‰ä½ç½®ä¿¡æ¯ï¼Œæ›´æ–°ä½ç½®æ˜¾ç¤º
                if (user.locationId) {
                    loadLocationInfo(user.locationId);
                }
            }
        } catch (error) {
            console.error('Error loading owner info:', error);
        }
    }

    // åŠ è½½ä½ç½®ä¿¡æ¯ï¼ˆåŸºäºLocationæ¨¡å‹ï¼‰
    async function loadLocationInfo(locationId) {
        try {
            const response = await fetch(`/api/locations/${locationId}`);
            if (response.ok) {
                const location = await response.json();
                const locationText = `${location.city || ''}, ${location.state || ''}`.trim() ||
                    location.country || 'Location not specified';

                document.getElementById('item-location').textContent = locationText;
                document.getElementById('location-meta').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading location info:', error);
        }
    }


    async function loadOrderInfo(itemId) {
        try {

            const response = await fetch(`/api/orders/item/${itemId}`);
            console.log("fetched /api/orders/item");
            if (!response.ok) {
                console.log('No orders found for this item');
                // æ˜¾ç¤ºæ— è®¢å•çŠ¶æ€
                document.getElementById('no-order').style.display = 'block';
                document.getElementById('order-info').style.display = 'none';
                return;
            }

            const data = await response.json();
            console.log(data);
            // æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•
            if (!data.orders || data.orders.length === 0) {
                document.getElementById('no-order').style.display = 'block';
                document.getElementById('order-info').style.display = 'none';
                return;
            }

            // æ‰¾åˆ°çŠ¶æ€ä¸ºactiveæˆ–pendingçš„è®¢å•ï¼ˆä¼˜å…ˆæ˜¾ç¤ºactiveï¼‰
            const activeOrder = data.orders.find(o =>
                o.status === 'active' || o.status === 'complete'
            );
            const pendingOrder = data.orders.find(o =>
                o.status === 'pending'
            );

            const displayOrder = activeOrder || pendingOrder;

            if (displayOrder) {
                // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
                document.getElementById('no-order').style.display = 'none';
                document.getElementById('order-info').style.display = 'block';

                // å¡«å……è®¢å•ä¿¡æ¯
                document.getElementById('order-id').textContent = `#${displayOrder.orderId}`;

                // æ˜¾ç¤ºå€Ÿç”¨è€…åç§°ï¼ˆä»è®¢å•æ•°æ®ä¸­ç›´æ¥è·å–ï¼‰
                if (displayOrder.borrower) {
                    document.getElementById('renter-name').textContent = displayOrder.borrower.username;
                } else {
                    // å¦‚æœè®¢å•ä¸­æ²¡æœ‰å€Ÿç”¨è€…ä¿¡æ¯ï¼Œåˆ™å•ç‹¬è·å–
                    await loadBorrowerInfo(displayOrder.borrowerId);
                }

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateOrderStatusDisplay(displayOrder.status);

                // å¦‚æœæœ‰è¯·æ±‚ä¿¡æ¯ï¼Œå¯ä»¥æ˜¾ç¤ºæ—¥æœŸ
                if (displayOrder.request) {
                    addOrderDateInfo(displayOrder.request);
                }
            } else {
                // åªæœ‰å·²å®Œæˆæˆ–å·²å–æ¶ˆçš„è®¢å•
                document.getElementById('no-order').style.display = 'block';
                document.getElementById('order-info').style.display = 'none';

                // å¯é€‰ï¼šæ˜¾ç¤ºå†å²è®¢å•æ•°é‡
                if (data.summary) {
                    updateOrderSummary(data.summary);
                }
            }

        } catch (error) {
            console.error('Error loading order info:', error);
            document.getElementById('no-order').style.display = 'block';
            document.getElementById('order-info').style.display = 'none';
        }
    }

    // å•ç‹¬åŠ è½½å€Ÿç”¨è€…ä¿¡æ¯çš„è¾…åŠ©å‡½æ•°
    async function loadBorrowerInfo(borrowerId) {
        try {
            const response = await fetch(`/api/users/${borrowerId}`);
            if (response.ok) {
                const data = await response.json();
                const user = data.user_info || data;
                const borrowerName = `${user.firstName || ''} ${user.lastName || ''}`.trim() ||
                    user.username || `User #${borrowerId}`;
                document.getElementById('renter-name').textContent = borrowerName;
            } else {
                document.getElementById('renter-name').textContent = `User #${borrowerId}`;
            }
        } catch (error) {
            document.getElementById('renter-name').textContent = `User #${borrowerId}`;
        }
    }

    // æ›´æ–°è®¢å•çŠ¶æ€æ˜¾ç¤ºçš„è¾…åŠ©å‡½æ•°
    function updateOrderStatusDisplay(status) {
        const statusElement = document.getElementById('order-status');
        const statusBadge = document.getElementById('status-badge');
        const rentBtn = document.getElementById('rent-btn');

        // å¤„ç†æšä¸¾å€¼æˆ–å­—ç¬¦ä¸²
        const statusValue = typeof status === 'object' ? status.value : status;

        switch(statusValue) {
            case 'pending':
                statusElement.textContent = 'Pending';
                statusElement.className = 'order-status pending';
                statusBadge.textContent = 'Reserved';
                statusBadge.className = 'item-status-badge rented';
                rentBtn.disabled = true;
                rentBtn.textContent = 'Currently Unavailable';
                break;
            case 'active':
                statusElement.textContent = 'Active';
                statusElement.className = 'order-status active';
                statusBadge.textContent = 'Rented';
                statusBadge.className = 'item-status-badge rented';
                rentBtn.disabled = true;
                rentBtn.textContent = 'Currently Unavailable';
                break;
            case 'complete':
                statusElement.textContent = 'Completed';
                statusElement.className = 'order-status completed';
                break;
            case 'cancelled':
                statusElement.textContent = 'Cancelled';
                statusElement.className = 'order-status cancelled';
                break;
            default:
                statusElement.textContent = statusValue || 'Unknown';
                statusElement.className = 'order-status';
        }
    }

    // æ·»åŠ è®¢å•æ—¥æœŸä¿¡æ¯ï¼ˆå¦‚æœæœ‰è¯·æ±‚æ•°æ®ï¼‰
    function addOrderDateInfo(request) {
        if (!request) return;

        const orderInfo = document.getElementById('order-info');

        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ—¥æœŸä¿¡æ¯
        if (!document.getElementById('order-dates')) {
            const datesHtml = `
                <div id="order-dates">
                    <div class="order-detail">
                        <span class="order-label">Start Date:</span>
                        <span class="order-value" id="order-start-date">-</span>
                    </div>
                    <div class="order-detail">
                        <span class="order-label">End Date:</span>
                        <span class="order-value" id="order-end-date">-</span>
                    </div>
                </div>
            `;
            orderInfo.insertAdjacentHTML('beforeend', datesHtml);
        }

        if (request.startDate) {
            const startDate = new Date(request.startDate);
            document.getElementById('order-start-date').textContent = startDate.toLocaleDateString();
        }

        if (request.endDate) {
            const endDate = new Date(request.endDate);
            document.getElementById('order-end-date').textContent = endDate.toLocaleDateString();
        }
    }

    // æ›´æ–°è®¢å•ç»Ÿè®¡æ‘˜è¦ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
    function updateOrderSummary(summary) {
        if (!summary) return;

        const noOrderDiv = document.getElementById('no-order');

        // æ·»åŠ å†å²è®¢å•ç»Ÿè®¡
        const summaryHtml = `
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="font-size: 14px; color: #666; margin: 5px 0;">
                    <strong>Order History:</strong>
                </p>
                ${summary.complete > 0 ? `<p style="font-size: 13px; color: #999; margin: 3px 0;">âœ“ ${summary.complete} completed</p>` : ''}
                ${summary.cancelled > 0 ? `<p style="font-size: 13px; color: #999; margin: 3px 0;">âœ— ${summary.cancelled} cancelled</p>` : ''}
                ${summary.total_orders > 0 ? `<p style="font-size: 13px; color: #999; margin: 3px 0;">Total: ${summary.total_orders} orders</p>` : ''}
            </div>
        `;

        // åªåœ¨æœ‰å†å²è®¢å•æ—¶æ˜¾ç¤º
        if (summary.total_orders > 0) {
            noOrderDiv.insertAdjacentHTML('beforeend', summaryHtml);
        }
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„è¯·æ±‚
    async function checkPendingRequests(itemId) {
        try {
            // ä½¿ç”¨ä»Flaskä¼ é€’çš„currentUserIdæˆ–ä»å­˜å‚¨è·å–
            const userId = currentUserId ||
                localStorage.getItem('userId') ||
                sessionStorage.getItem('userId');

            if (!userId) return;

            // è·å–ç”¨æˆ·çš„è¯·æ±‚
            const response = await fetch(`/api/requests/${userId}`);
            if (!response.ok) return;

            const data = await response.json();
            const sentRequests = data.sent || [];

            // æ£€æŸ¥æ˜¯å¦å·²ç»å¯¹è¿™ä¸ªç‰©å“å‘é€äº†è¯·æ±‚
            const existingRequest = sentRequests.find(req =>
                req.itemId === parseInt(itemId) &&
                req.status === 'PENDING'
            );

            if (existingRequest) {
                const rentBtn = document.getElementById('rent-btn');
                rentBtn.textContent = 'Request Pending';
                rentBtn.disabled = true;
                rentBtn.className = 'btn btn-pending';
            }
        } catch (error) {
            console.error('Error checking pending requests:', error);
        }
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºç‰©å“æ‰€æœ‰è€…
    function checkOwnership(ownerId) {
        // ä½¿ç”¨ä»Flaskä¼ é€’çš„currentUserIdï¼Œæˆ–ä»å­˜å‚¨ä¸­è·å–
        const userId = currentUserId ||
            localStorage.getItem('userId') ||
            sessionStorage.getItem('userId');

        if (userId && parseInt(userId) === ownerId) {
            // æ˜¯ç‰©å“æ‰€æœ‰è€…ï¼Œæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
            document.getElementById('rent-btn').style.display = 'none';
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('delete-btn').style.display = 'block';
        } else {
            // ä¸æ˜¯æ‰€æœ‰è€…ï¼Œåªæ˜¾ç¤ºç§ŸèµæŒ‰é’®
            document.getElementById('rent-btn').style.display = 'block';
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('delete-btn').style.display = 'none';
        }
    }

    // æ”¹è¿›çš„ç§Ÿèµç‰©å“å‡½æ•°ï¼ˆä½¿ç”¨Requestç³»ç»Ÿï¼‰
    async function rentItem() {
        // ä½¿ç”¨ä»Flaskä¼ é€’çš„currentUserIdæˆ–ä»å­˜å‚¨è·å–
        const userId = currentUserId ||
            localStorage.getItem('user_id') ||
            sessionStorage.getItem('user_id');

        console.log('Current User ID:', userId);
        console.log('Session Storage:', sessionStorage);
        console.log('Local Storage:', localStorage);

        if (!userId) {
            alert('Please login to rent this item.');
            window.location.href = '/auth/login';
            return;
        }

        // åˆ›å»ºç§Ÿèµè¯·æ±‚è¡¨å•æ¨¡æ€æ¡†
        const modalHtml = `
            <div id="rental-modal" class="modal-overlay">
                <div class="modal-content">
                    <h2 class="modal-title">Request to Rent: ${currentItem.itemName}</h2>

                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="start-date-input" min="${new Date().toISOString().split('T')[0]}" required>
                    </div>

                    <div class="form-group">
                        <label>End Date *</label>
                        <input type="date" id="end-date-input" min="${new Date().toISOString().split('T')[0]}" required>
                    </div>

                    <div class="form-group">
                        <label>Message to Owner (Optional)</label>
                        <textarea id="message-input" rows="3" placeholder="Add a message for the owner..."></textarea>
                    </div>

                    <div class="item-price-display" style="font-size: 20px; text-align: center; margin: 20px 0;">
                        Total: <span id="total-price">$0</span>
                        <br>
                        <small style="color: #999;">($${currentItem.price || 0}/day Ã— <span id="days-count">0</span> days)</small>
                    </div>

                    <div class="modal-buttons">
                        <button class="btn btn-secondary" onclick="closeRentalModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitRentalRequest()">Send Request</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // æ·»åŠ æ—¥æœŸå˜åŒ–ç›‘å¬å™¨æ¥æ›´æ–°ä»·æ ¼
        document.getElementById('start-date-input').addEventListener('change', updateTotalPrice);
        document.getElementById('end-date-input').addEventListener('change', updateTotalPrice);
    }

    // æ›´æ–°æ€»ä»·æ ¼
    function updateTotalPrice() {
        const startDate = document.getElementById('start-date-input').value;
        const endDate = document.getElementById('end-date-input').value;

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            if (days > 0) {
                const totalPrice = (currentItem.price || 0) * days;
                document.getElementById('total-price').textContent = `$${totalPrice.toFixed(2)}`;
                document.getElementById('days-count').textContent = days;
            }
        }
    }

    // å…³é—­ç§Ÿèµæ¨¡æ€æ¡†
    window.closeRentalModal = function() {
        const modal = document.getElementById('rental-modal');
        if (modal) {
            modal.remove();
        }
    }

    // æäº¤ç§Ÿèµè¯·æ±‚
    window.submitRentalRequest = async function() {
        const startDateInput = document.getElementById('start-date-input').value;
        const endDateInput = document.getElementById('end-date-input').value;
        const message = document.getElementById('message-input').value;

        // è°ƒè¯•ä¿¡æ¯
        console.log('Start Date Input:', startDateInput);
        console.log('End Date Input:', endDateInput);

        if (!startDateInput || !endDateInput) {
            alert('Please select both start and end dates.');
            return;
        }

        const startDate = new Date(startDateInput);
        const endDate = new Date(endDateInput);

        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            alert('Invalid date format. Please select valid dates.');
            return;
        }

        if (startDate >= endDate) {
            alert('End date must be after start date.');
            return;
        }

        try {

            const requestData = {
                itemId: parseInt(itemId),
                startDate: startDateInput,  // ç›´æ¥ä½¿ç”¨è¾“å…¥å€¼ "2025-11-28"
                endDate: endDateInput,      // ç›´æ¥ä½¿ç”¨è¾“å…¥å€¼ "2025-11-29"
                message: message || ''
            };


            // const requestData = {
            //     itemId: parseInt(itemId),
            //     startDate: startDate.toISOString(),
            //     endDate: endDate.toISOString(),
            //     message: message || ''
            // };


            // const formatDateTime = (dateStr) => {
            //     const date = new Date(dateStr);
            //     const year = date.getFullYear();
            //     const month = String(date.getMonth() + 1).padStart(2, '0');
            //     const day = String(date.getDate()).padStart(2, '0');
            //     return `${year}-${month}-${day} 00:00:00`;
            // };
            // const requestData = {
            //     itemId: parseInt(itemId),
            //     startDate: formatDateTime(startDateInput),
            //     endDate: formatDateTime(endDateInput),
            //     message: message || ''
            // };

            console.log('Request Data being sent:', requestData);

            const response = await fetch('/api/requests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            const responseData = await response.json();
            console.log('Response from server:', responseData);

            if (response.ok) {
                alert('Rental request sent successfully! The owner will review your request.');
                closeRentalModal();
                const rentBtn = document.getElementById('rent-btn');
                rentBtn.textContent = 'Request Pending';
                rentBtn.disabled = true;
                rentBtn.className = 'btn btn-pending';
            } else {
                console.error('Error response:', responseData);
                alert(`Failed to send request: ${responseData.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error creating rental request:', error);
            alert('An error occurred. Please try again.');
        }
    }

    // ç¼–è¾‘ç‰©å“
    function editItem() {
        window.location.href = `/api/items/${itemId}/edit`;
    }

    // åˆ é™¤ç‰©å“
    async function deleteItem() {
        if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/items/${itemId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                alert('Item deleted successfully!');
                window.location.href = '/items/search';
            } else {
                alert('Failed to delete item. Please try again.');
            }
        } catch (error) {
            console.error('Error deleting item:', error);
            alert('An error occurred while deleting the item.');
        }
    }

    // è”ç³»æ‰€æœ‰è€…
    function contactOwner() {
        const ownerId = document.querySelector('.owner-info-card').dataset.ownerId;

        if (ownerId) {
            window.location.href = `/users/${ownerId}`;
        } else {
            alert('Owner profile is not available.');
        }
    }
</script>
</body>
</html>